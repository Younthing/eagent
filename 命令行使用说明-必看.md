**CLI 使用说明（简版）**

**一页速用**
```bash
cp .env.example .env
# 打开 .env，至少填一个：OPENAI_API_KEY=... 或 ANTHROPIC_API_KEY=...
uv sync
uv run rob2 run /path/to.pdf --output-dir results --json
```

**核心命令：rob2 run**
最常用：
```bash
uv run rob2 run example/2.Angelone.pdf
```

输出开关：
- `--output-dir results`：写入目录（默认 `results`）
- `--json`：把 JSON 打到终端
- `--table/--no-table`：是否打印 ROB2 表格
- `--html`：生成 `results/report.html`
- `--docx`：生成 `results/report.docx`
- `--pdf`：生成 `results/report.pdf`

特性开关（用 `--set` 打开/关闭）：
- `--set domain_audit_mode=llm|none`：全篇审计补证据（最贵但最强）
- `--set query_planner=llm|deterministic`：多查询规划（提升召回，变慢）
- `--set reranker=cross_encoder|none`：重排（更准，变慢）
- `--set use_structure=true|false`：结构感知过滤（推荐 true）
- `--set llm_locator_mode=llm|none`：精定位引用（更准，变慢）
- `--set relevance_mode=llm|none`：相关性验证（更准，变慢）
- `--set consistency_mode=llm|none`：一致性验证（更准，变慢）

**批量命令：rob2 batch run**
目录批量执行（递归收集 PDF）：
```bash
uv run rob2 batch run /path/to/pdf_dir --output-dir results/batch --json
```

批量模式特点：
- 默认递归收集 `*.pdf`（大小写不敏感），按相对路径排序
- 输出按“相对路径展开”写入
- 自动从 `batch_checkpoint.json` 断点恢复
- 若输入目录/选项变化导致 checkpoint 不一致，会严格报错，需加 `--reset`
- 单文件失败不会中断整批，最终在汇总中标记

批量输出文件：
- `results/batch/batch_checkpoint.json`
- `results/batch/batch_summary.json`
- `results/batch/batch_summary.csv`
- `results/batch/batch_traffic_light.png`（经典红绿灯图）
- `results/batch/<relative_path_without_ext>/result.json`

常用参数：
- `--options` / `--options-file` / `--set key=value`
- `--table/--no-table`
- `--html` / `--docx` / `--pdf`
- `--batch-id` / `--batch-name`
- `--reset`：忽略历史 checkpoint 重新执行
- `--plot/--no-plot`：批量结束后是否自动生成红绿灯图（默认开启）
- `--plot-output /path/to/custom.png`：指定自动出图路径

单独绘制已有批量结果：
```bash
# 输入目录（自动读取 batch_summary.json）
uv run rob2 batch plot results/batch

# 输入 summary 文件并自定义输出路径
uv run rob2 batch plot results/batch/batch_summary.json --output results/batch/custom_traffic_light.png

# 包含 failed/pending/running 项（灰色占位）
uv run rob2 batch plot results/batch --include-non-success
```

三套模板（直接复制）：
1. 快速省钱
```bash
uv run rob2 run /path/to.pdf --output-dir results --json \
  --set domain_audit_mode=none \
  --set reranker=none \
  --set query_planner=deterministic \
  --set llm_locator_mode=none \
  --set relevance_mode=none \
  --set consistency_mode=none
```

2. 平衡默认
```bash
uv run rob2 run /path/to.pdf --output-dir results --json \
  --set domain_audit_mode=none \
  --set use_structure=true \
  --set reranker=cross_encoder
```

3. 质量优先
```bash
uv run rob2 run /path/to.pdf --output-dir results --json \
  --set use_structure=true \
  --set query_planner=llm \
  --set llm_locator_mode=llm \
  --set relevance_mode=llm \
  --set consistency_mode=llm \
  --set domain_audit_mode=llm
```

**结果在哪里**
输出目录（给人看）：
- `results/result.json`
- `results/table.md`
- `results/report.html` / `results/report.docx` / `results/report.pdf`

持久化目录（给调试用，默认开启）：
- `data/rob2/runs/<run_id>/result.json`
- `data/rob2/runs/<run_id>/doc_structure.json`
- `data/rob2/runs/<run_id>/validated_candidates.json`

**高级配置（需要时再看）**
配置优先级（从高到低）：
1. `--set`
2. `--options-file`
3. `--options`
4. 环境变量 `.env`
5. 默认值

三种配置方式：
```bash
uv run rob2 config example --output rob2.options.yaml
uv run rob2 run /path/to.pdf --options-file rob2.options.yaml
uv run rob2 run /path/to.pdf --set top_k=8 --set query_planner=llm
```

想看所有可配项：
```bash
uv run rob2 config options
uv run rob2 config options --schema
```

常用环境变量（.env）：
- `OPENAI_API_KEY` / `ANTHROPIC_API_KEY`
- `PROMPT_LANG=zh|en`
- `SPLADE_MODEL_ID=./models/...`
- `DOMAIN_AUDIT_MODE=llm|none`
- `LLM_LOCATOR_MODE=llm|none`
- `RELEVANCE_MODEL=...` / `CONSISTENCY_MODEL=...`
- `CACHE_SCOPE=deterministic|none`

**其他命令（调试用）**
- `rob2 config` / `rob2 questions` / `rob2 graph` / `rob2 preprocess`
- `rob2 retrieval` / `rob2 fusion` / `rob2 locator` / `rob2 validate`
- `rob2 audit` / `rob2 cache` / `rob2 playground`

文档元数据抽取（仅元数据）：
```bash
uv run rob2 preprocess metadata example/2.Angelone.pdf
```

查看每个命令的帮助：
```bash
uv run rob2 -h
uv run rob2 validate -h
```

**排错**
- `Options file not found`：检查 `--options-file` 路径
- `ASCII 视图需要安装 grandalf`：`uv pip install grandalf`
- 模型下载慢：优先用本地模型目录（`SPLADE_MODEL_ID=./models/...`）
